{% extends "base.html" %}
{% load static %}

{% block title %}Console - {{ vm.name }}{% endblock %}

{% block extra_css %}
<style>
    body {
        margin: 0;
        padding: 0;
        overflow: hidden;
    }

    .console-container {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: #000;
        display: flex;
        flex-direction: column;
    }

    .console-header {
        background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
        color: white;
        padding: 12px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        z-index: 1000;
    }

    .console-info {
        display: flex;
        gap: 20px;
        align-items: center;
    }

    .vm-name {
        font-size: 18px;
        font-weight: 600;
    }

    .vm-status {
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
        {% if vm.status == 'running' %}
        background: rgba(16, 185, 129, 0.2);
        color: #10b981;
        {% else %}
        background: rgba(239, 68, 68, 0.2);
        color: #ef4444;
        {% endif %}
    }

    .console-actions {
        display: flex;
        gap: 10px;
    }

    .btn-console {
        padding: 8px 16px;
        border-radius: 8px;
        border: none;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        font-size: 14px;
    }

    .btn-close {
        background: rgba(239, 68, 68, 0.2);
        color: #ef4444;
    }

    .btn-close:hover {
        background: rgba(239, 68, 68, 0.3);
    }

    .btn-fullscreen {
        background: rgba(59, 130, 246, 0.2);
        color: #3b82f6;
    }

    .btn-fullscreen:hover {
        background: rgba(59, 130, 246, 0.3);
    }

    #novnc-container {
        flex: 1;
        position: relative;
        background: #000;
    }

    #noVNC_canvas {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
    }

    .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 999;
    }

    .spinner {
        border: 4px solid rgba(255, 255, 255, 0.1);
        border-left-color: #3b82f6;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    .loading-text {
        color: #fff;
        margin-top: 20px;
        font-size: 16px;
    }

    .error-message {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(239, 68, 68, 0.9);
        color: white;
        padding: 20px 40px;
        border-radius: 12px;
        font-size: 16px;
        display: none;
    }
</style>
{% endblock %}

{% block content %}
<div class="console-container">
    <div class="console-header">
        <div class="console-info">
            <div class="vm-name">
                <i class="bi bi-display"></i> {{ vm.name }} (ID: {{ vm.vmid }})
            </div>
            <div class="vm-status">{{ vm.status|upper }}</div>
            <div style="color: #94a3b8; font-size: 14px;">
                {{ vm.node.name }} @ {{ vm.node.cluster.name }}
            </div>
        </div>
        <div class="console-actions">
            <button class="btn-console btn-fullscreen" onclick="toggleFullscreen()">
                <i class="bi bi-arrows-fullscreen"></i> Fullscreen
            </button>
            <button class="btn-console btn-close" onclick="closeConsole()">
                <i class="bi bi-x-lg"></i> Close
            </button>
        </div>
    </div>

    <div id="novnc-container">
        <div class="loading-overlay" id="loading">
            <div class="spinner"></div>
            <div class="loading-text">Connecting to console...</div>
        </div>
        <div class="error-message" id="error"></div>
    </div>
</div>

<script type="module">
    import RFB from '/usr/share/novnc/core/rfb.js';

    let rfb;
    const proxmoxHost = "{{ proxmox_host }}";
    const vncPort = {{ vnc_port }};
    const vncTicket = "{{ vnc_ticket }}";
    const vmType = "{{ vm_type }}";

    // Build WebSocket URL using websockify on port 6080
    // The ws_token format is: vmid_proxmoxhost_vncport
    // Our custom plugin will create the SSH tunnel automatically
    const wsToken = "{{ ws_token }}";
    const wsUrl = `wss://${window.location.host}:6080/websockify?token=${wsToken}`;

    console.log('Connecting to WebSocket:', wsUrl);

    function showError(message) {
        document.getElementById('loading').style.display = 'none';
        const errorEl = document.getElementById('error');
        errorEl.textContent = message;
        errorEl.style.display = 'block';
    }

    function connectVNC() {
        try {
            // Create RFB instance
            rfb = new RFB(document.getElementById('novnc-container'), wsUrl, {
                credentials: {
                    password: vncTicket
                }
            });

            // Event handlers
            rfb.addEventListener('connect', () => {
                console.log('VNC connected successfully');
                document.getElementById('loading').style.display = 'none';
            });

            rfb.addEventListener('disconnect', (e) => {
                console.log('VNC disconnected:', e.detail);
                if (e.detail.clean) {
                    console.log('Clean disconnect');
                } else {
                    showError('Disconnected from console: ' + (e.detail.reason || 'Unknown error'));
                }
            });

            rfb.addEventListener('credentialsrequired', () => {
                console.log('Credentials required');
                showError('Authentication required');
            });

            rfb.addEventListener('securityfailure', (e) => {
                console.error('Security failure:', e.detail);
                showError('Security failure: ' + (e.detail.reason || 'Unknown error'));
            });

            // Set quality settings
            rfb.scaleViewport = true;
            rfb.resizeSession = true;
            rfb.qualityLevel = 6;
            rfb.compressionLevel = 2;

        } catch (err) {
            console.error('Failed to create VNC connection:', err);
            showError('Failed to connect: ' + err.message);
        }
    }

    // Connect on page load
    window.addEventListener('DOMContentLoaded', connectVNC);

    // Cleanup on page unload
    window.addEventListener('beforeunload', () => {
        if (rfb) {
            rfb.disconnect();
        }
    });

    // Global functions for buttons
    window.toggleFullscreen = function() {
        const container = document.querySelector('.console-container');
        if (!document.fullscreenElement) {
            container.requestFullscreen();
        } else {
            document.exitFullscreen();
        }
    };

    window.closeConsole = function() {
        if (rfb) {
            rfb.disconnect();
        }
        window.location.href = "{% url 'vm_detail' vm.id %}";
    };
</script>
{% endblock %}
